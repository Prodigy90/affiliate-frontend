name: Build and Deploy

on:
  push:
    branches: [main]
    paths-ignore:
      - '*.md'
      - 'docs/**'
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Set image name to lowercase
        id: image
        run: echo "name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.image.outputs.name }}
          tags: |
            type=sha,prefix=
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          platforms: linux/amd64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            NEXT_PUBLIC_API_URL=${{ vars.AFFILIATE_API_URL }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Summary
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Image: \`${{ steps.meta.outputs.tags }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${GITHUB_SHA::8}\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Check if KUBECONFIG is configured
        id: check_kubeconfig
        run: |
          if [ -z "${{ secrets.KUBECONFIG }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "::warning::KUBECONFIG secret not configured - skipping deployment"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Set up kubectl
        if: steps.check_kubeconfig.outputs.configured == 'true'
        uses: azure/setup-kubectl@v3
        with:
          version: 'v1.29.0'

      - name: Configure kubeconfig
        if: steps.check_kubeconfig.outputs.configured == 'true'
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Deploy to Kubernetes
        if: steps.check_kubeconfig.outputs.configured == 'true'
        run: |
          echo "Deploying affiliate-frontend to wasbot-prod..."
          kubectl -n wasbot-prod rollout restart deployment affiliate-frontend
          kubectl -n wasbot-prod rollout status deployment affiliate-frontend --timeout=180s

      - name: Rollback on failure
        if: failure() && steps.check_kubeconfig.outputs.configured == 'true'
        run: |
          echo "Deployment failed, rolling back..."
          kubectl -n wasbot-prod rollout undo deployment affiliate-frontend
          kubectl -n wasbot-prod rollout status deployment affiliate-frontend --timeout=60s
          exit 1

      - name: Notify Discord (Success)
        if: success() && steps.check_kubeconfig.outputs.configured == 'true'
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -s -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "✅ affiliate-frontend Deployed",
                  "description": "Successfully deployed to production",
                  "color": 5763719,
                  "fields": [
                    {"name": "Commit", "value": "`'"${GITHUB_SHA::8}"'`", "inline": true},
                    {"name": "Branch", "value": "`${{ github.ref_name }}`", "inline": true}
                  ]
                }]
              }' \
              "$DISCORD_WEBHOOK"
          fi
        continue-on-error: true

      - name: Notify Discord (Failure)
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          if [ -n "$DISCORD_WEBHOOK" ]; then
            curl -s -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "❌ affiliate-frontend Deploy Failed",
                  "description": "Deployment failed and was rolled back",
                  "color": 15548997,
                  "fields": [
                    {"name": "Commit", "value": "`'"${GITHUB_SHA::8}"'`", "inline": true},
                    {"name": "Logs", "value": "[View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})", "inline": true}
                  ]
                }]
              }' \
              "$DISCORD_WEBHOOK"
          fi
        continue-on-error: true

      - name: Deployment Summary
        if: steps.check_kubeconfig.outputs.configured == 'true'
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Namespace: \`wasbot-prod\`" >> $GITHUB_STEP_SUMMARY
          echo "- Deployment: \`affiliate-frontend\`" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: \`${GITHUB_SHA::8}\`" >> $GITHUB_STEP_SUMMARY
